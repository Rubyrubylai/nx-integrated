version: 2.1
orbs:
  nx: nrwl/nx@1.6.1
commands:
  set-version-env:
    description: Set SHA1_TAG, SERVER_VERSION, NX_MAIN_BRANCH
    steps:
      - run:
          name: set env var
          command: |
            NX_MAIN_BRANCH="test"

            case $CIRCLE_BRANCH in
              test)
                ENVIRONMENT='test'
                NX_MAIN_BRANCH='test'
                ;;
              master)
                ENVIRONMENT='production'
                NX_MAIN_BRANCH='master'
                ;;
            esac
            echo 'export SHA1_TAG=${CIRCLE_SHA1:0:7}' >> $BASH_ENV
            echo 'export SERVER_VERSION="$(date +%s)-${SHA1_TAG}"' >> $BASH_ENV
            echo 'export ENVIRONMENT=$ENVIRONMENT' >> $BASH_ENV
            echo 'export NX_MAIN_BRANCH=${NX_MAIN_BRANCH}' >> $BASH_ENV
            source $BASH_ENV
jobs:
  lint:
    docker:
      - image: cimg/node:lts-browsers
    steps:
      - checkout
      - set-version-env
      - run: npm ci
      - nx/set-shas:
          main-branch-name: $CIRCLE_BRANCH

      - run: npx nx format:check
      - run: npx nx affected --base=$NX_BASE -t lint --parallel=3
  test:
    docker:
      - image: cimg/node:lts-browsers
    steps:
      - checkout
      - set-version-env
      - run: npm ci
      - nx/set-shas:
          main-branch-name: $CIRCLE_BRANCH
      - run:
          name: Print environment variables
          command: |
            echo "CIRCLE_BRANCH: $CIRCLE_BRANCH"
            echo "NX_MAIN_BRANCH: $NX_MAIN_BRANCH"
            echo "NX_BASE: $NX_BASE"
            echo "NX_HEAD: $NX_HEAD"

      - run: npx nx affected:test --base=$NX_BASE --parallel=3
  build:
    docker:
      - image: cimg/node:lts-browsers
    steps:
      - checkout
      - set-version-env
      - run: npm ci
      - nx/set-shas:
          main-branch-name: $CIRCLE_BRANCH

      - run: npx nx affected --base=$NX_BASE -t build servers --parallel=3
workflows:
  lint-test-push:
    jobs:
      - lint
      - test
